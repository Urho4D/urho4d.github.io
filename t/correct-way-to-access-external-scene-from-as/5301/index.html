<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width" name="viewport"/>
  <title>
   Correct way to access external Scene from AS
  </title>
  <link href="../../../archived.css" rel="stylesheet"/>
  <script type="text/x-mathjax-config">
   MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\\\(','\\\\)']]}});
  </script>
  <script async="" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML" type="text/javascript">
  </script>
 </head>
 <body>
  <header class="header">
   <div class="title-span">
    <a href="../../../">
     <img alt="Urho3D" height="40" id="site-logo" src="../../../images/site-logo.png"/>
    </a>
   </div>
  </header>
  <div class="main">
   <div class="archive-span">
    Archive 19/01/2023.
   </div>
   <h1 class="topic-title">
    Correct way to access external Scene from AS
   </h1>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/f8c56838151bae9112a91eeb86f55cc4ef2fdee5ef2d25afc934b4d508949063.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      Leith
     </div>
     <div class="post_content">
      <p>
       My C++ application ‘asynchronously’ loads a scene that contains a ScriptInstance attached to an otherwise empty node… it’s just a simplified test for c++/angelscript interop.
       <br/>
       I rely on Urho to instantiate the test angelscript object during scene loading…
      </p>
      <p>
       The following script appears to run without problems in the (old) editor, but when called from a c++ app built against the current master branch (with no changes to the codebase), the commented lines cause Urho to crash when the Update script method “tries” to return to Scene::Update… basically I’m trying to get access, from within script, to the scene which owns the node which owns the ScriptInstance…
      </p>
      <p>
       No exception is generated by angelscript - execution of the method always completes, but “on the way out” (as we return to caller Scene::Update) we crash for some odd reason in StringHash equality compare with a clearly corrupted callstack (RAX holds an invalid pointer sourced from a corrupt input parameter on the stackframe).
      </p>
      <p>
       What am I doing wrong here, that could cause stack corruption on the c++ call stack?
      </p>
      <pre><code class="lang-auto">class Actor:ScriptObject
{
	String actorName="zombie1";
	Node@ ownNode_;

	bool hasTarget_;
	Actor@ Target_;
}


class Zombie:Actor
{
	void Start(){
		ownNode_ = node;
	}

	void Update(float dT){
		Print("Update ZOMBIE: "+actorName);

	//	Scene@ myScene = scene;
//		if(myScene is null)
//			return;

		Print("DONE!");
	}</code></pre>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/f8c56838151bae9112a91eeb86f55cc4ef2fdee5ef2d25afc934b4d508949063.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      Leith
     </div>
     <div class="post_content">
      <p>
       I did a bit more digging into this issue, starting with a backtrace of the call stack… with those lines uncommented, the Scene::Update(float) method is crashing just after broadcasting the scene update event… at that point, the code is attempting to access the Scene::smoothedTransforms_ variantmap, and we crash, evidentally because the Scene has somehow been destroyed, such that “this” has become an invalid pointer, and as a consequence, accessing any member is an invalid operation.
      </p>
      <p>
       Now I was curious, so I tracked down where the “scene” global is being registered, which is in SceneAPI.cpp:
      </p>
      <pre><code class="lang-auto">    engine-&gt;RegisterGlobalFunction("Scene@+ get_scene()", asFUNCTION(GetScriptContextScene), asCALL_CDECL);</code></pre>
      <p>
       Note the “+” symbol… that’s an auto-handle, my understanding is that the “+” tells angelscript to automatically add one to the RefCount, such that the object in question won’t be destroyed when it goes out of scope in the script.
       <br/>
       However according to my experiment, accessing the scene global property from script is causing the scene to be garbage collected by angelscript, despite the use of auto handle in the declaration.
      </p>
      <p>
       Am I not understanding something here?
       <img alt=":slight_smile:" class="emoji" src="../../../images/8a8941f0486df9dda1e89ec988e1591cf959e1ea7809a249dc2decb694b30a6c.png" title=":slight_smile:"/>
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/f8c56838151bae9112a91eeb86f55cc4ef2fdee5ef2d25afc934b4d508949063.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      Leith
     </div>
     <div class="post_content">
      <p>
       Storing the scene object handle (returned by global property getter) in a script global variable makes the problem go away - since the object reference never goes out of scope, the scene is not destroyed out from under our feet… this is definitely not an ideal solution.
      </p>
      <p>
       I have to ask myself about this ownership arrangement, whereby querying for access to the container Scene transfers ownership of the Scene object lifetime from C++ to AngelScript… at least now I know exactly what’s been going on, even if I don’t completely understand why things are the way they are (with respect to how we register certain classes with angelscript).
      </p>
      <p>
       I’m going to mark this workaround as a Solution because it does solve the problem, however I am far from happy with this outcome.
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/62a71395d4c17ae6d13ba5dd2ab14fd64e5b7af1784f42b10524e596f6c9a9f6.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      SirNate0
     </div>
     <div class="post_content">
      <p>
       Is the scene in question stored in a shared pointer somewhere else in your application? It occurs to me that if it’s not there behavior described might be expected, as when we leave the AngelScript code the ref count would be zero and the scene would be destroyed.
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/f8c56838151bae9112a91eeb86f55cc4ef2fdee5ef2d25afc934b4d508949063.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      Leith
     </div>
     <div class="post_content">
      <p>
       Yep, the scene is held by a sharedptr within my state manager (implemented as a separate scene and a fistful of custom components).
      </p>
      <p>
       [EDIT]
       <br/>
       NOPE - On closer inspection, the GamePlayState object is using a raw pointer to store the current game scene - mystery solved! I should know better than to use a raw pointer for a storage type - its acceptable to hand around raw pointers as call arguments, but bad form to use them to hold anything… mea culpa
       <br/>
       I had initially considered the possibility that I was not holding onto the scene correctly, and made the very blind assumption that since I had a manager in place, ownership should be clear - but the manager was poorly formed, and is currently undergoing some brutal refactoring and verification - where one egg is bad, there’s usually more
      </p>
     </div>
    </div>
   </div>
  </div>
 </body>
</html>