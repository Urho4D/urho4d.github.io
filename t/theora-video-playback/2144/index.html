<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width" name="viewport"/>
  <title>
   Theora video playback
  </title>
  <link href="../../../archived.css" rel="stylesheet"/>
  <script type="text/x-mathjax-config">
   MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\\\(','\\\\)']]}});
  </script>
  <script async="" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML" type="text/javascript">
  </script>
 </head>
 <body>
  <header class="header">
   <div class="title-span">
    <a href="../../../">
     <img alt="Urho3D" height="40" id="site-logo" src="../../../images/site-logo.png"/>
    </a>
   </div>
  </header>
  <div class="main">
   <div class="archive-span">
    Archive 19/01/2023.
   </div>
   <h1 class="topic-title">
    Theora video playback
   </h1>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/999065d0609f591a82c8a3f4f534d814fd1605f4d7ed98ff3bc0d9aed9d27d87.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      codingmonkey
     </div>
     <div class="post_content">
      <p>
       Hi folks!
       <br/>
       There is my adaptation for Urho3D of the Orange’s example with Theora playback on textures
      </p>
      <aside class="onebox whitelistedgeneric">
       <header class="source">
        <img class="site-icon" height="32" src="../../../images/6a9577cd4f7fa6b75bde1025af85b944e9dd1388373b55ccba6e9f80ac2eae60.svg" width="32"/>
        <a href="https://github.com/MonkeyFirst/Urho3DTheora/" target="_blank">
         GitHub
        </a>
       </header>
       <article class="onebox-body">
        <img class="thumbnail onebox-avatar" height="400" src="../../../images/851efe42e628bcfe70fae16f00cc2aa07e3e59559bf0d2679a970ce5bb478c72" width="400"/>
        <h3>
         <a href="https://github.com/MonkeyFirst/Urho3DTheora/" target="_blank">
          MonkeyFirst/Urho3DTheora
         </a>
        </h3>
        <p>
         Urho3D Theora Video. Contribute to MonkeyFirst/Urho3DTheora development by creating an account on GitHub.
        </p>
       </article>
       <div class="onebox-metadata">
       </div>
       <div style="clear: both">
       </div>
      </aside>
      <div class="onebox lazyYT" data-height="270" data-parameters="feature=oembed&amp;wmode=opaque" data-width="480" data-youtube-id="Wap1Ye5-qsY" data-youtube-title="Theora playback test 1 (without audio stream processing)">
       <a href="https://www.youtube.com/watch?v=Wap1Ye5-qsY" target="_blank">
        <img class="ytp-thumbnail-image" height="270" src="../../../images/a5c5c200d34c45e6d04205fd8cf3f43bf1e365f8a4e94fd1905c90cc402b619f.jpg" title="Theora playback test 1 (without audio stream processing)" width="480"/>
       </a>
      </div>
      <ul>
       <li>
        previous CPU color decoding was removed
       </li>
       <li>
        last version have only OpenGL shader for GPU color decoding
       </li>
      </ul>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/684585e23c00534a4d0cb1c1bc542909f34fad260b0ad446b3e3b5a99d7771d5.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      sabotage3d
     </div>
     <div class="post_content">
      <p>
       Nice work. I am thinking of doing the same for OpenCV.
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/9f4d89a6ec8768b8bd5426c30c4812f04cddcb7e43e803179951cb20a4f1c8bf.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      Modanung
     </div>
     <div class="post_content">
      <p>
       Cool!
       <img alt=":smiley:" class="emoji" src="../../../images/771063f3b2b4950334f4d187069c87041036842149b3e4268221db325b6bde0e.png" title=":smiley:"/>
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/9e484e760615ae1055c98a33975f0abfde7a99cbe48f85a088138e5ac5daabc8.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      Mike
     </div>
     <div class="post_content">
      <p>
       Awesome
       <img alt=":stuck_out_tongue:" class="emoji" src="../../../images/3163a5e255227b243910497d540132fb6658b673e5dce9a6039c26309d51eb0f.png" title=":stuck_out_tongue:"/>
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/999065d0609f591a82c8a3f4f534d814fd1605f4d7ed98ff3bc0d9aed9d27d87.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      codingmonkey
     </div>
     <div class="post_content">
      <p>
       Thanks )
       <br/>
       I guess it still working only for the one movie, that i testing. So there are a lot of work in future
      </p>
      <aside class="quote no-group">
       <blockquote>
        <p>
         I am thinking of doing the same for OpenCV.
        </p>
       </blockquote>
      </aside>
      <p>
       computer vison + urho3d you mean? for what ?
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/668470d56163353e1e4d4d67dadbcf02db3f7389e58e6e01b1650a16815e3949.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      Enhex
     </div>
     <div class="post_content">
      <p>
       Nice work.
       <br/>
       Could be very useful for games, playing intro’s, cut-scenes, and such.
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/999065d0609f591a82c8a3f4f534d814fd1605f4d7ed98ff3bc0d9aed9d27d87.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      codingmonkey
     </div>
     <div class="post_content">
      <aside class="quote">
       <blockquote>
        <p>
         Could be very useful for games, playing intro’s, cut-scenes, and such.
        </p>
       </blockquote>
      </aside>
      <p>
       Yes, that’s is common case of usage.
      </p>
      <p>
       Previously I’m also locking on FFmpeg, but i suppose it has bad licence for urho3d ? (GPL)
      </p>
      <p>
       Theora has BSD licence
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/9ecd58e1ecfa9c23f52a7001747ac5d5851912007d88f62cad8848af897737f1.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      TheSHEEEP
     </div>
     <div class="post_content">
      <p>
       FFmpeg itself is LGPL, which is fine as long as you link dynamically.
       <br/>
       Some libraries that FFmpeg can be built with (most known, x264) are GPL licensed.
       <br/>
       But if you have full control of assets, there is no reason not to use OGG video / theora instead.
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/0afd0002f7f053f9608d7c41ebd4d8b88a023db3ec5ef0bbe723627da0b24ec9.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      miz
     </div>
     <div class="post_content">
      <p>
       Firstly, nice work!
      </p>
      <p>
       Secondly, I’m trying to make this work in a BorderImage but having trouble converting properly to RGB from YUV. Any idea how i could do this? At the moment I’ve got the black and white from the Y element of the video displaying on a BorderImage by doing:
      </p>
      <pre><code class="lang-auto"></code></pre>
      <p>
       At the bottom of UpdatePlaneTextures(). This works. (I’ve taken away the code that renders it to a material in the scene)
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/1942bc04975c75156629598f61ba11bcc001f312ff469070f61448e051f874dd.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      Lumak
     </div>
     <div class="post_content">
      <p>
       Awesome work! Finally getting around to testing this and the video works great but missing sound.
      </p>
      <p>
       edit: maybe it’s not supposed to have audio?
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/1942bc04975c75156629598f61ba11bcc001f312ff469070f61448e051f874dd.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      Lumak
     </div>
     <div class="post_content">
      <p>
       Playing audio using Urho3D’s BufferedStreamAudio:
       <br/>
      </p>
      <div class="lazyYT" data-height="270" data-parameters="feature=oembed&amp;wmode=opaque" data-width="480" data-youtube-id="0GCDoQaBR4I" data-youtube-title="Theora VidAud">
      </div>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/b8f5dad81b656072038634f7e88edcb9a54ec3432d6d48dbaba8878d623899bd.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      Dave82
     </div>
     <div class="post_content">
      <p>
       Excellent work !This would be a nice addon for Urho3d ! Do you plan to make it open source ?
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/1942bc04975c75156629598f61ba11bcc001f312ff469070f61448e051f874dd.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      Lumak
     </div>
     <div class="post_content">
      <p>
       The video/audio player that you see is literally this example,
       <a href="https://github.com/Lumak/Urho3D-Theora/blob/master/Source/ThirdParty/libtheora/examples/player_example.c">
        https://github.com/Lumak/Urho3D-Theora/blob/master/Source/ThirdParty/libtheora/examples/player_example.c
       </a>
       in the repo.
       <br/>
       Instead of using AUDIO_DEVICE and ioctrl fns, use the BufferedStreamAudio, the video conversion from yuv420 to rgba is already there. I’m still having trouble with audio synchronization, as you can hear some skipping in the video, and studying the process.
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/1942bc04975c75156629598f61ba11bcc001f312ff469070f61448e051f874dd.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      Lumak
     </div>
     <div class="post_content">
      <p>
       Audio should be in sync now,
       <a href="https://github.com/Lumak/Urho3D-Theora">
        https://github.com/Lumak/Urho3D-Theora
       </a>
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/b8f5dad81b656072038634f7e88edcb9a54ec3432d6d48dbaba8878d623899bd.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      Dave82
     </div>
     <div class="post_content">
      <p>
       Just found some time to test it ! Works perfectly ! Even CPU decoding is really fast (No serious impact on CPU usage).
      </p>
      <p>
       Excellent work ! Thank you !
       <br/>
       Definitely will use this for my cutscenes !
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/b8f5dad81b656072038634f7e88edcb9a54ec3432d6d48dbaba8878d623899bd.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      Dave82
     </div>
     <div class="post_content">
      <p>
       I found a small issue with the player. If i run the app in windowed mode and the window loses focus the video and audio start going out of sync the audio starts to crackle and the video just freezes randomly. (the same issue as in your video)
       <br/>
       Also limiting the fps affects the video playback speed which makes sense but is there any solution to run updates independently of fps ? Maybe the whole update procedure should be in an other thread ?
      </p>
      <p>
       The cpu usage is below 20% while playing the video so its not a hardware issue
      </p>
      <p>
       EDIT : Tried it with my own video (1280 * 768) and even with maximum fps the audio goes out of sync after 7-8 seconds…
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/d4cf3830911459ab503a214fec4a49494d5ec5b67931d1b4ea923aa8ea91a1cd.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      Pencheff
     </div>
     <div class="post_content">
      <p>
       Looking at the code, I think HandleUpdate() should do multiple UpdateTheora() calls until decoding is up to date with latest possible data. I would recommend doing the decoding in separate thread and signaling the main thread when a video/audio frame data is ready, then doing texture blit on the main thread.
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/1942bc04975c75156629598f61ba11bcc001f312ff469070f61448e051f874dd.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      Lumak
     </div>
     <div class="post_content">
      <p>
       At the bottom of the UpdateTheora() fn, there’s a loop correction section:
      </p>
      <pre><code class="lang-auto">      // correction loops
      // note: audioTime_ will remain negative (-1000) until vorbis actually acquires a vorbis packet
      audioOffset = audioTime_ - elapsedTime_;

      if (audioOffset &lt; 0)
      {
          if (++numLoops &gt; MAX_CORRECTIVE_LOOPS)
          {
              break;
          }
      }
      else
      {
          break;
      }
</code></pre>
      <p>
       Check the audioOffset and see how far it lags behind, and instead of using MAX_CORRECTIVE_LOOPS, you might consider a fixed desirable offset value.
      </p>
      <p>
       Pseudo code might look something like:
      </p>
      <pre><code class="lang-auto">      if (audioTime_ != -1000LL &amp;&amp; audioOffset &lt; -5LL)
         then continue looping
     else
        break
</code></pre>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/1942bc04975c75156629598f61ba11bcc001f312ff469070f61448e051f874dd.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      Lumak
     </div>
     <div class="post_content">
      <p>
       Updated the repo with the corrective audio loop fix.
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/b8f5dad81b656072038634f7e88edcb9a54ec3432d6d48dbaba8878d623899bd.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      Dave82
     </div>
     <div class="post_content">
      <p>
       I turned Vsync on and it totally ruined the playback (extreme stuttering and frame freezes)…
       <br/>
       Seems it really needs a separate thread for decoding.
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/1942bc04975c75156629598f61ba11bcc001f312ff469070f61448e051f874dd.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      Lumak
     </div>
     <div class="post_content">
      <p>
       That’s something that I didn’t test. I’ll take a look at it soon.
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/b8f5dad81b656072038634f7e88edcb9a54ec3432d6d48dbaba8878d623899bd.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      Dave82
     </div>
     <div class="post_content">
      <p>
       Any news about this ? Just found some info about similar issues in Unity. Maybe it helps.
       <br/>
       <a class="onebox" href="https://answers.unity.com/questions/119236/jerky-fullscreen-video-playback.html" rel="nofollow noopener" target="_blank">
        https://answers.unity.com/questions/119236/jerky-fullscreen-video-playback.html
       </a>
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/b8f5dad81b656072038634f7e88edcb9a54ec3432d6d48dbaba8878d623899bd.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      Dave82
     </div>
     <div class="post_content">
      <p>
       Tried to convert some cutscenes to ogv and the videoplayer can’t play them (crash at entering the decode loop)… Tried literally all possible settings (kbit/sec / audio format , bitrate etc) in free ogv video converter and all settings result in crash… i suspect there’s something wrong with the audio but right now i’m just need to calm down because otherwise  i’ll pull my hair out…
       <br/>
       Also started to write my own ffmpeg player but building that crap on windows is so ridiculously convoluted
       <br/>
       that it just doesn’t worth the time and energy to fiddle with a bloated mess like that.
      </p>
      <p>
       Situations like these can turn the wonderful world of “open sourceness” into a smelly devastated landfill…
       <br/>
       Just giving few more tries and if it doesn’t work i will try to switch to a Windows only solution where i can at least step over this make|rake|cmake|download this tool|install package | install another package | set home environment | download a library which after you build will download another library that is required to build the 3rd library…
      </p>
      <p>
       Time for coffee and beer.
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/1942bc04975c75156629598f61ba11bcc001f312ff469070f61448e051f874dd.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      Lumak
     </div>
     <div class="post_content">
      <p>
       I’m on my Christmas break now and decided to tackle some unfinished projects, starting with this one since I promised to do it.
      </p>
      <p>
       I created another theora video using VLC (ffmpeg didn’t work), and here’s the sample video.
      </p>
      <div class="onebox lazyYT lazyYT-container" data-parameters="feature=oembed&amp;wmode=opaque" data-youtube-id="mCp-i4PB9us" data-youtube-title="Theora video in Urho3D">
       <a href="https://www.youtube.com/watch?v=mCp-i4PB9us" rel="noopener nofollow ugc" target="_blank">
        <img class="ytp-thumbnail-image" height="360" src="../../../images/a5fff25f143908ab312324049ede97af61b3176901239819551dc7b16ef8e895.jpg" title="Theora video in Urho3D" width="480"/>
       </a>
      </div>
      <p>
       I’ll update the repo shortly.
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/b2a8c7c22223e46073dee26c10aaf9a4d267d7f33d4aa46502c55dba672a9b69.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      Bluemoon
     </div>
     <div class="post_content">
      <p>
       I don’t know which to comment on; the fact that this works or the awesome drummer
       <img alt=":smile:" class="emoji" src="../../../images/ae89e05450587e8f1f4786c0d266cf94ef2b306782fb6f9c30e43c0023ed148b.png" title=":smile:"/>
      </p>
      <p>
       Okay back on point, this is amazing.
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/6718f5168c50ac3f4db4727bdc9fe70a3c1908f4490220b13cc1883e91ae2e26.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      Batch
     </div>
     <div class="post_content">
      <p>
       I played around with this and it works well, but I’m having trouble determining when playback is complete. Does anyone know how to go about doing that? I tried implementing cutscenes with it, but I didn’t know when to remove the UI elements that were rendering it.
      </p>
     </div>
    </div>
   </div>
  </div>
 </body>
</html>