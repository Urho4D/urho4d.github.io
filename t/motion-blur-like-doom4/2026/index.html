<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width" name="viewport"/>
  <title>
   Motion Blur like Doom4
  </title>
  <link href="../../../archived.css" rel="stylesheet"/>
  <script type="text/x-mathjax-config">
   MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\\\(','\\\\)']]}});
  </script>
  <script async="" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML" type="text/javascript">
  </script>
 </head>
 <body>
  <header class="header">
   <div class="title-span">
    <a href="../../../">
     <img alt="Urho3D" height="40" id="site-logo" src="../../../images/site-logo.png"/>
    </a>
   </div>
  </header>
  <div class="main">
   <div class="archive-span">
    Archive 19/01/2023.
   </div>
   <h1 class="topic-title">
    Motion Blur like Doom4
   </h1>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/9e06bdaa9b192f1c9d4940fdd01e33b947cc0445d7b50f3766849acf8c3db6d9.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      1vanK
     </div>
     <div class="post_content">
      <p>
       <a href="https://github.com/1vanK/Urho3DMotionBlur">
        github.com/1vanK/Urho3DMotionBlur
       </a>
      </p>
      <p>
       Use START_DEMO.bat for launch
      </p>
      <p>
       <img alt="" height="300" src="../../../images/c40cd8a512f07882cd2f9686a83d031dc0e1bacaba7d91e9755c4e780e2071a3.gif" width="400"/>
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/c01b8b8b05b6aab492df6eeace88e2282147607ff86cdc28638e9227819a3fcc.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      Bananaft
     </div>
     <div class="post_content">
      <p>
       Looks really neat and smooth.
       <br/>
       So it uses camera transform and only affected by camera motion? Or it uses full velocity vectors pass, and can blur many separated objects?
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/9e06bdaa9b192f1c9d4940fdd01e33b947cc0445d7b50f3766849acf8c3db6d9.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      1vanK
     </div>
     <div class="post_content">
      <p>
       [quote=“Bananaft”]Looks really neat and smooth.
       <br/>
       So it uses camera transform and only affected by camera motion? Or it uses full velocity vectors pass, and can blur many separated objects?[/quote]
      </p>
      <p>
       only camera motion
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/5775ca4ae33489a2bcc299dd30363673c37d994ec83cfc8b666b914026ff2719.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      rasteron
     </div>
     <div class="post_content">
      <p>
       nice.
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/684585e23c00534a4d0cb1c1bc542909f34fad260b0ad446b3e3b5a99d7771d5.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      sabotage3d
     </div>
     <div class="post_content">
      <p>
       Its pretty cool. I am getting bugs on my OSX. The motion blur is jittering and there is motion blur only in some areas of the screen.
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/9e06bdaa9b192f1c9d4940fdd01e33b947cc0445d7b50f3766849acf8c3db6d9.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      1vanK
     </div>
     <div class="post_content">
      <aside class="quote">
       <div class="title">
        <div class="quote-controls">
        </div>
        <img alt="" class="avatar" height="20" src="../../../images/3cdea62ad0216f21e73a6da462369f1460ff7ce292c657c1f27905a800b56144.png" width="20"/>
        sabotage3d:
       </div>
       <blockquote>
        <p>
         Its pretty cool. I am getting bugs on my OSX. The motion blur is jittering and there is motion blur only in some areas of the screen.
        </p>
       </blockquote>
      </aside>
      <p>
       try to turn on vsync (options -v)
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/9e06bdaa9b192f1c9d4940fdd01e33b947cc0445d7b50f3766849acf8c3db6d9.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      1vanK
     </div>
     <div class="post_content">
      <p>
       Also whether you are using the latest version of the engine?
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/05a34ea39902a28016d8d9c16fad38ff94bbc543c686ebf24d99f0fda3337406.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      Egorbo
     </div>
     <div class="post_content">
      <p>
       Wow! looks nice, does it work on GLES iOS/Android?
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/9e06bdaa9b192f1c9d4940fdd01e33b947cc0445d7b50f3766849acf8c3db6d9.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      1vanK
     </div>
     <div class="post_content">
      <aside class="quote">
       <div class="title">
        <div class="quote-controls">
        </div>
        <img alt="" class="avatar" height="20" src="../../../images/bf558de05f3ccb60affa8174313e5cbc179abc0302a907c80bfaf981e5e7c451.png" width="20"/>
        Egorbo:
       </div>
       <blockquote>
        <p>
         Wow! looks nice, does it work on GLES iOS/Android?
        </p>
       </blockquote>
      </aside>
      <p>
       I have not tested
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/67709b783eb27b06c746f3e8d1a378101b708641a574271416371fa9ad51f031.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      Cpl.Bator
     </div>
     <div class="post_content">
      <p>
       Very nice ! ( with -v that work fine here ) , great job ! what the next ? dof ?
       <img alt=":smiley:" class="emoji" src="../../../images/771063f3b2b4950334f4d187069c87041036842149b3e4268221db325b6bde0e.png" title=":smiley:"/>
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/9e06bdaa9b192f1c9d4940fdd01e33b947cc0445d7b50f3766849acf8c3db6d9.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      1vanK
     </div>
     <div class="post_content">
      <aside class="quote no-group" data-username="Cpl.Bator">
       <div class="title">
        <div class="quote-controls">
        </div>
        <img alt="" class="avatar" height="20" src="../../../images/57d7ae91b07e8a8b86e7e0e40d0f58a4d9dbe52e0bc6f30ef8c17a26e8ba5dc2.png" width="20"/>
        Cpl.Bator:
       </div>
       <blockquote>
        <p>
         Very nice ! ( with -v that work fine here ) , great job ! what the next ? dof ?
         <img alt=":smiley:" class="emoji" src="../../../images/771063f3b2b4950334f4d187069c87041036842149b3e4268221db325b6bde0e.png" title=":smiley:"/>
        </p>
       </blockquote>
      </aside>
      <p>
       This shader is not finished yet (it uses an additional forward light pass for weapon and I can not solve a couple of issues). I have reworked version with mask for weapon, but additional texture affects performance
      </p>
      <p>
       dof already implemented by monkeyfirst
       <a href="https://github.com/MonkeyFirst/urho3d-post-process-dof">
        github.com/MonkeyFirst/urho3d-post-process-dof
       </a>
       (but as far as I remember, there is need to improve)
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/9e06bdaa9b192f1c9d4940fdd01e33b947cc0445d7b50f3766849acf8c3db6d9.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      1vanK
     </div>
     <div class="post_content">
      <p>
       Please test updated version. Whether there is a problems WITHOUT vsync? New version render scene to texture and blurs it there, but not just in the viewport
      </p>
      <p>
       EDIT: for launch still use START_DEMO.bat
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/67709b783eb27b06c746f3e8d1a378101b708641a574271416371fa9ad51f031.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      Cpl.Bator
     </div>
     <div class="post_content">
      <p>
       work fine without vsync.
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/9e06bdaa9b192f1c9d4940fdd01e33b947cc0445d7b50f3766849acf8c3db6d9.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      1vanK
     </div>
     <div class="post_content">
      <aside class="quote no-group" data-username="Cpl.Bator">
       <div class="title">
        <div class="quote-controls">
        </div>
        <img alt="" class="avatar" height="20" src="../../../images/57d7ae91b07e8a8b86e7e0e40d0f58a4d9dbe52e0bc6f30ef8c17a26e8ba5dc2.png" width="20"/>
        Cpl.Bator:
       </div>
       <blockquote>
        <p>
         work fine without vsync.
        </p>
       </blockquote>
      </aside>
      <p>
       ok, but now it is impossible to turn off effect by tag, need use another renderpath without motion blur …
      </p>
      <p>
       EDIT: although I have an idea
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/684585e23c00534a4d0cb1c1bc542909f34fad260b0ad446b3e3b5a99d7771d5.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      sabotage3d
     </div>
     <div class="post_content">
      <p>
       It works properly with vsync it looks pretty cool.
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/9e06bdaa9b192f1c9d4940fdd01e33b947cc0445d7b50f3766849acf8c3db6d9.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      1vanK
     </div>
     <div class="post_content">
      <p>
       Have you problems with other shaders (Blur, Bloom) when VSync is disabled?
      </p>
      <p>
       EDIT: a have a hypothesis that engine on some frames start showing viewport before bluring when vsync is disabled and fps is high
       <br/>
       EDIT2: someone can test problem by using WithoutMask.bat in repo (u can change window size to 200x700 for increasing fps)
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/9f4d89a6ec8768b8bd5426c30c4812f04cddcb7e43e803179951cb20a4f1c8bf.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      Modanung
     </div>
     <div class="post_content">
      <p>
       For some reason I had to use
       <span class="bbcode-i">
        -ap
       </span>
       flag for the Urho3DPlayer to locate the CoreData folder and then merge the Final folder into that one and the Data folder for it to find all the resources. Then I saw a baked room (Andrew Price’s right?) and a textured pistol, but
       <span class="bbcode-u">
        no blur
       </span>
       .
       <br/>
       I’m on Xubuntu Linux 64-bit using the proprietary Nvidia drivers. Which - apart from the occasional heavy frame drops - tends to outperform the open Xorg drivers. Switching back to Xorg is a pain though, otherwise I’d be happy to test with those.
       <br/>
       I’ve tried the
       <span class="bbcode-i">
        -v
       </span>
       option; no help.
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/9e06bdaa9b192f1c9d4940fdd01e33b947cc0445d7b50f3766849acf8c3db6d9.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      1vanK
     </div>
     <div class="post_content">
      <p>
       [quote=“Modanung”]For some reason I had to use
       <span class="bbcode-i">
        -ap
       </span>
       flag for the Urho3DPlayer to locate the CoreData folder and then merge the Final folder into that one and the Data folder for it to find all the resources. Then I saw a baked room (Andrew Price’s right?) and a textured pistol, but
       <span class="bbcode-u">
        no blur
       </span>
       .
       <br/>
       I’m on Xubuntu Linux 64-bit using the proprietary Nvidia drivers. Which - apart from the occasional heavy frame drops - tends to outperform the open Xorg drivers. Switching back to Xorg is a pain though, otherwise I’d be happy to test with those.
       <br/>
       I’ve tried the
       <span class="bbcode-i">
        -v
       </span>
       option; no help.[/quote]
      </p>
      <p>
       Any warnings or errors in log?
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/9f4d89a6ec8768b8bd5426c30c4812f04cddcb7e43e803179951cb20a4f1c8bf.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      Modanung
     </div>
     <div class="post_content">
      <aside class="quote">
       <div class="title">
        <div class="quote-controls">
        </div>
        <img alt="" class="avatar" height="20" src="../../../images/a1e7f9ad87f0f286c93981b5211d942802658cbde3e5ac7e346468cf1d0aceb2.png" width="20"/>
        1vanK:
       </div>
       <blockquote>
        <p>
         Any warnings or errors in log?
        </p>
       </blockquote>
      </aside>
      <p>
       None
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/9e06bdaa9b192f1c9d4940fdd01e33b947cc0445d7b50f3766849acf8c3db6d9.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      1vanK
     </div>
     <div class="post_content">
      <p>
       I have no ideas. Try output in shader intermediate steps.
      </p>
      <p>
       Weapon maskt:
      </p>
      <p>
       [code]void PS()
       <br/>
       {
       <br/>
       float weaponmask = texture2DProj(sDiffMap, vScreenPos).a;
      </p>
      <pre><code>gl_FragColor = vec4(weaponmask);
</code></pre>
      <p>
       }
       <br/>
       [/code]
      </p>
      <p>
       <a data-bbcode="true" href="http://savepic.ru/9855112.htm">
        <img alt="" height="" src="../../../images/8b316d9c130f6357abdb197b3d65e7046078f861b44f07e89b5e155575c6bb2b.png" width=""/>
       </a>
      </p>
      <p>
       Depth:
      </p>
      <p>
       [code]void PS()
       <br/>
       {
       <br/>
       float depth = ReconstructDepth(texture2DProj(sDepthBuffer, vScreenPos).r);
      </p>
      <pre><code>gl_FragColor = vec4(depth * 20);
</code></pre>
      <p>
       }
       <br/>
       [/code]
      </p>
      <p>
       <a data-bbcode="true" href="http://savepic.ru/9849992.htm">
        <img alt="" height="" src="../../../images/8b316d9c130f6357abdb197b3d65e7046078f861b44f07e89b5e155575c6bb2b.png" width=""/>
       </a>
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/9f4d89a6ec8768b8bd5426c30c4812f04cddcb7e43e803179951cb20a4f1c8bf.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      Modanung
     </div>
     <div class="post_content">
      <p>
       I am getting identical result with those pixel shaders.
      </p>
      <p>
       Also it turns out the path argument required to be enclosed in quotation marks to get all three folders across.
      </p>
      <p>
       WithMask: Same as Final
       <br/>
       WithoutMask: A screen filling flickering in tones of the room with the occasional contour of a window. The gun is rendered fine.
       <br/>
       ViewportAlpha: Like Final, but with a pitch black gun.
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/9e06bdaa9b192f1c9d4940fdd01e33b947cc0445d7b50f3766849acf8c3db6d9.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      1vanK
     </div>
     <div class="post_content">
      <p>
       Try
      </p>
      <p>
       [code]
       <br/>
       void PS()
       <br/>
       {
       <br/>
       float weaponmask = texture2DProj(sDiffMap, vScreenPos).a;
      </p>
      <pre><code>//gl_FragColor = vec4(mask);
//return;

if (weaponmask == 0)
{
    gl_FragColor = texture2DProj(sDiffMap, vScreenPos).rgba;
    return;
}

// HWDEPTH
float depth = ReconstructDepth(texture2DProj(sDepthBuffer, vScreenPos).r);



vec3 worldPos = vFarRay * depth / vScreenPos.w;
worldPos += cCameraPosPS;

vec4 oldClipPos = vec4(worldPos, 1.0) * cOldViewProj;
oldClipPos /= oldClipPos.w;

vec4 oldScreenPos = vec4(oldClipPos.x * vGBufferOffsets.z + vGBufferOffsets.x * oldClipPos.w,
                    oldClipPos.y * vGBufferOffsets.w + vGBufferOffsets.y * oldClipPos.w,
                    0.0, oldClipPos.w);

vec4 offset = (vScreenPos - oldScreenPos);
offset = offset / (cTimeStep * 20.0);

gl_FragColor = offset;
</code></pre>
      <p>
       }[/code]
      </p>
      <p>
       It should show different colors when you move a the mouse
      </p>
      <p>
       <a data-bbcode="true" href="http://savepic.ru/9836552.htm">
        <img alt="" height="" src="../../../images/8b316d9c130f6357abdb197b3d65e7046078f861b44f07e89b5e155575c6bb2b.png" width=""/>
       </a>
      </p>
      <p>
       Also try to remove all comments from shader. May be it not works with UTF8 comments
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/9e06bdaa9b192f1c9d4940fdd01e33b947cc0445d7b50f3766849acf8c3db6d9.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      1vanK
     </div>
     <div class="post_content">
      <p>
       Also are you using the latest version of the engine?
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/9f4d89a6ec8768b8bd5426c30c4812f04cddcb7e43e803179951cb20a4f1c8bf.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      Modanung
     </div>
     <div class="post_content">
      <aside class="quote">
       <div class="title">
        <div class="quote-controls">
        </div>
        <img alt="" class="avatar" height="20" src="../../../images/a1e7f9ad87f0f286c93981b5211d942802658cbde3e5ac7e346468cf1d0aceb2.png" width="20"/>
        1vanK:
       </div>
       <blockquote>
        <p>
         Also are you using the latest version of the engine?
        </p>
       </blockquote>
      </aside>
      <p>
       Yep
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/9e06bdaa9b192f1c9d4940fdd01e33b947cc0445d7b50f3766849acf8c3db6d9.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      1vanK
     </div>
     <div class="post_content">
      <p>
       Repo moved to
       <a href="https://github.com/1vanK/Urho3DMotionBlur">
        github.com/1vanK/Urho3DMotionBlur
       </a>
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/684585e23c00534a4d0cb1c1bc542909f34fad260b0ad446b3e3b5a99d7771d5.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      sabotage3d
     </div>
     <div class="post_content">
      <p>
       Is it possible to use the same technique for a depth of field effect?
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/9e06bdaa9b192f1c9d4940fdd01e33b947cc0445d7b50f3766849acf8c3db6d9.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      1vanK
     </div>
     <div class="post_content">
      <aside class="quote">
       <div class="title">
        <div class="quote-controls">
        </div>
        <img alt="" class="avatar" height="20" src="../../../images/3cdea62ad0216f21e73a6da462369f1460ff7ce292c657c1f27905a800b56144.png" width="20"/>
        sabotage3d:
       </div>
       <blockquote>
        <p>
         Is it possible to use the same technique for a depth of field effect?
        </p>
       </blockquote>
      </aside>
      <p>
       I think there is nothing in common. Even pixel blurring algorithm is other. Easier write a DOF shader from scratch,  than try to take something useful from this
      </p>
     </div>
    </div>
   </div>
  </div>
 </body>
</html>