<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width" name="viewport"/>
  <title>
   Raycast vehicle
  </title>
  <link href="../../../archived.css" rel="stylesheet"/>
  <script type="text/x-mathjax-config">
   MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\\\(','\\\\)']]}});
  </script>
  <script async="" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML" type="text/javascript">
  </script>
 </head>
 <body>
  <header class="header">
   <div class="title-span">
    <a href="../../../">
     <img alt="Urho3D" height="40" id="site-logo" src="../../../images/site-logo.png"/>
    </a>
   </div>
  </header>
  <div class="main">
   <div class="archive-span">
    Archive 19/01/2023.
   </div>
   <h1 class="topic-title">
    Raycast vehicle
   </h1>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/28ebc440ecd4098f2a6ad505cdc9ec368de1a0cd2616ecbd951089089330fbd9.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      slapin
     </div>
     <div class="post_content">
      <p>
       Hi, all!
      </p>
      <p>
       For some time I was making city sandbox and got some progress.
      </p>
      <p>
       Doing a car (AI and controlled by player) I was using Urho example
       <br/>
       from vehicle demo and now I find that it doesn’t fit what I make due to following reasons:
      </p>
      <ol>
       <li>
        <p>
         It is very difficult to control, car is getting stuck quickly and in general it is very hard
         <br/>
         to make it work in complicated environment. One ends-up hacking-up all behavior,
         <br/>
         so while using physics is great, working-around physics is not, and it seems that Bullet
         <br/>
         physics is not advance enough to make reliable vehicles. Not mentioning wheels stuck in terrain
         <img alt=":frowning:" class="emoji" src="../../../images/f52368fabff51bf20b9b2a7726cfecb3ca01ecdec8d99f872cca862812b131a7.png" title=":frowning:"/>
        </p>
       </li>
       <li>
        <p>
         LODding  the vehicle behaviors (i.e. path motion/physics motion with collision) and spawning does have
         <br/>
         too much side effects.
        </p>
       </li>
      </ol>
      <p>
       So after fighting things for several months I think it is better to move on and go for raycast vehicle.
       <br/>
       I’ve been reading Internet for quite some time on subject but it looks like I don’t have some basic knowledge
       <br/>
       pros know, so I still can’t understand the concept.
      </p>
      <p>
       <span class="bbcode-b">
        So what I really ask for is to put me into right direction - are there any good theory links to read about
        <br/>
        these? I want GTA3 level of car physics. I know it is hard work, I don’t have problem with it I just need to know
        <br/>
        where to begin.
       </span>
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/9f4d89a6ec8768b8bd5426c30c4812f04cddcb7e43e803179951cb20a4f1c8bf.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      Modanung
     </div>
     <div class="post_content">
      <p>
       Starting with the sample, adding some suspension to the vehicle would help a lot when it comes to both realism and control.
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/28ebc440ecd4098f2a6ad505cdc9ec368de1a0cd2616ecbd951089089330fbd9.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      slapin
     </div>
     <div class="post_content">
      <p>
       Sorry for being so dumb, but - what do you mean by “adding suspension”?
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/65f09c7224ca68a4d16618500cded4d288c4f6d5f84eb5eaff93394c1608f946.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      johnnycable
     </div>
     <div class="post_content">
      <p>
       A counter-force impulse when the car bump into something, like the bump cars in playing parks… you know that, don’t you?
       <br/>
       Just a little spin, not too strong… a little recoil…
       <br/>
       then measure the “medium stuck force” of your simulation and set the bump to go over that…
       <br/>
       just messin
       <img alt=":wink:" class="emoji" src="../../../images/f6b86554472159b74d0ab91b2cb3cd75cf361ccf96a141a4ebd3363c38e7f8eb.png" title=":wink:"/>
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/9f4d89a6ec8768b8bd5426c30c4812f04cddcb7e43e803179951cb20a4f1c8bf.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      Modanung
     </div>
     <div class="post_content">
      <p>
       What I guess I’m saying is… flinstone mobile ain’t got these:
       <img alt=":wink:" class="emoji" src="../../../images/f6b86554472159b74d0ab91b2cb3cd75cf361ccf96a141a4ebd3363c38e7f8eb.png" title=":wink:"/>
       <br/>
       <a href="https://en.wikipedia.org/wiki/Suspension_(vehicle)" rel="nofollow noopener">
        <img alt="Car suspension" height="500" src="../../../images/885bdc89415620ecf63ac32a576809d04c71747c897916a7975baff9549d0568.jpg" width="421"/>
       </a>
      </p>
      <p>
       Tires
       <span class="spoiler">
        not shown in image
        <img alt=":stuck_out_tongue_winking_eye:" class="emoji" src="../../../images/6a693010b77b3ab855dfa10f04416f7bd49775f13cb069c88c7c460e060e69d2.png" title=":stuck_out_tongue_winking_eye:"/>
       </span>
       also add some bounciness in real life making for longer contact with the road on take off. But this squeezing could probably be neglected after adding suspension. Tire friction does vary with pressure (both from air and suspension).
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/65f09c7224ca68a4d16618500cded4d288c4f6d5f84eb5eaff93394c1608f946.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      johnnycable
     </div>
     <div class="post_content">
      <p>
       Exactly what I had in mind, I swear
       <img alt=":grin:" class="emoji" src="../../../images/ed2d1ae8dcdaf6a12e9af7d7bced25db2c3e8f38e624f930d13ff697e3285e7b.png" title=":grin:"/>
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/9f4d89a6ec8768b8bd5426c30c4812f04cddcb7e43e803179951cb20a4f1c8bf.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      Modanung
     </div>
     <div class="post_content">
      <p>
       <img height="211" src="../../../images/a11cf6d5f4d14c33dbf5ca06a99a7ade75c893a9211f93f3bb67cac2e702b7cf.gif" width="498"/>
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/28ebc440ecd4098f2a6ad505cdc9ec368de1a0cd2616ecbd951089089330fbd9.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      slapin
     </div>
     <div class="post_content">
      <p>
       I see you guys having fun, I like it.
      </p>
      <p>
       Well, I found the simplest case.
      </p>
      <ol>
       <li>
        I now understand what spring force is. The idea is that I do raycast from some point to ground and notice its length.
        <br/>
        then I find the compression value
        <span class="bbcode-b">
         comp = raycast_distance / raycast_length
        </span>
        . And then I can find my force by
       </li>
      </ol>
      <p>
       <span class="bbcode-b">
        Vector3 spring = Vector3(0.0f, 1.0f, 0.0f) * k * comp
       </span>
       where k is multiplier value.
      </p>
      <ol start="2">
       <li>
        The problem is what to do with the result. If I do
        <span class="bbcode-b">
         body.AddForce(spring)
        </span>
        either nothing happens, or
        <br/>
        everything explodes. Any ideas on what to do next?
       </li>
      </ol>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/28ebc440ecd4098f2a6ad505cdc9ec368de1a0cd2616ecbd951089089330fbd9.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      slapin
     </div>
     <div class="post_content">
      <p>
       Also original example with 5 rigid bodies and constraints puts too much strain to CPU,
       <br/>
       which puts even i7 2500K to crawling position with 10 vehicles. I expect raycast car to be less intense…
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/c24c93e794e8d919ef829acfad2b3f83cbd23485bcd826225def4391e2fb0cb0.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      lezak
     </div>
     <div class="post_content">
      <p>
       Have You seen
       <a href="http://discourse.urho3d.io/t/offroad-vehicle/2450">
        offroad vehicle
       </a>
       made by
       <span class="mention">
        @Lumak
       </span>
       ?
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/9f4d89a6ec8768b8bd5426c30c4812f04cddcb7e43e803179951cb20a4f1c8bf.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      Modanung
     </div>
     <div class="post_content">
      <p>
       In most cases you’ll want to multiply your force with the timeStep.
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/1942bc04975c75156629598f61ba11bcc001f312ff469070f61448e051f874dd.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      Lumak
     </div>
     <div class="post_content">
      <p>
       He’s already admitted that that is too complicated for him.
      </p>
      <p>
       Edit: just realized that he said:
      </p>
      <aside class="quote no-group" data-post="1" data-topic="2982" data-username="slapin">
       <div class="title">
        <div class="quote-controls">
        </div>
        <img alt="" class="avatar" height="20" src="../../../images/237961ae9435b764c47cf0017625ceef2da2dad7dd8dea88e7197aecc4daca40.png" width="20"/>
        slapin:
       </div>
       <blockquote>
        <p>
         Bullet physics is not advance enough to make reliable vehicles
        </p>
       </blockquote>
      </aside>
      <p>
       deleted my suggestion.
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/28ebc440ecd4098f2a6ad505cdc9ec368de1a0cd2616ecbd951089089330fbd9.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      slapin
     </div>
     <div class="post_content">
      <p>
       <span class="mention">
        @Lumak
       </span>
       It appears that I said not really what I intended to say.
      </p>
      <p>
       I just mean that full physical vehicle with rigidbody for everything done in Urho3D
       <br/>
       Bullet integration does not allow to implement reliable vehicles. By this I mean vehicle based on example.
       <br/>
       The main problem is torque transform from RigidBody to actual motion - it is very hard (probably impossible)
       <br/>
       to get proper (controllable, predictable) behavior due to too many side effects. I never intended to say it is not possible to implement the required thing using Bullet directly as it exports enough hooks. But I’m really not ready for Bullet.
       <br/>
       It is too complicated to set up and too little documentation for me to understand. So I’d prefer to stick to some simple
       <br/>
       things for now. And yes,
       <span class="bbcode-b">
        your RaycastVehicle demo is great, but it is too complicated for me to understand at my current level
       </span>
       .
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/4b6da94ce9adab8331a1520c819e1d4ab2b8720bd4a1305bfa6f982ab9e9cf90.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      suncaller
     </div>
     <div class="post_content">
      <p>
       The Rocket League team implemented their own “fake physics” for similar reasons to what you suggest. I’ve read various discussions online about this simplified physics on reddit, GDC talks by the devs, etc. It might help to look into this game. Bullet physics likely won’t do the job here if you want to simulate some serious, complex vehicles.
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/1942bc04975c75156629598f61ba11bcc001f312ff469070f61448e051f874dd.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      Lumak
     </div>
     <div class="post_content">
      <p>
       Ah, ok. What I was going to suggest was this,
       <a href="http://discourse.urho3d.io/t/btraycastvehicle-example/1306">
        btRaycastVehicle example
       </a>
       <br/>
       A simple demonstration of btRaycastVehicle dynamics.
      </p>
      <p>
       But after reading what you said, or at least what I thought you meant, it would’ve been pointless to even suggest it.  But most raycast vehicle dynamics are about the same, you typically code the dynamics you’re looking for.
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/65f09c7224ca68a4d16618500cded4d288c4f6d5f84eb5eaff93394c1608f946.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      johnnycable
     </div>
     <div class="post_content">
      <p>
       Why not add checks for physics values into the update cycles? It’s easy to give infinite power impulse to a body, especially if you drag them around by changing their position with setPositionSomething…
       <br/>
       this is evil
       <img alt=":smiling_imp:" class="emoji" src="../../../images/13f3065da3da99b36f3035fa3bd7285197ff0e6d754b099726b94f471ed37c51.png" title=":smiling_imp:"/>
       you get teleport…
       <img alt=":fearful:" class="emoji" src="../../../images/927b7013d5b8aa621c5b0cec14781cd85094e4c431169c7afc8592b35aa3cb72.png" title=":fearful:"/>
       <br/>
       you need a good way of number crunching to fine tune physics…
       <br/>
       if you take for instance
       <span class="mention">
        @Modanung
       </span>
       “bumping car” physics example above, you see you could easily “sample” the impulse the car is being applied, then reverse it someway…
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/28ebc440ecd4098f2a6ad505cdc9ec368de1a0cd2616ecbd951089089330fbd9.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      slapin
     </div>
     <div class="post_content">
      <p>
       Well, it looks like it is not possible to implement raycast vehicle in Urho, as AddForce to RigidBody consumes extreme amount of CPU and FPS drops to about 12 fps for 10 cars on i7 2600K.
       <br/>
       For single vehicle and no other processing that is probably OK, but for several vehicles this doesn’t work at all.
      </p>
      <p>
       Is there any other ideas? I think I can just do ray/spherecast and move wheels up/down to prevent
       <br/>
       terrain penetration and use distances for proper hull positioning. Is there anything else I can do?
      </p>
      <p>
       Thanks!
      </p>
      <pre><code>void update(float timeStep)
{
    float comp = 0.0f;
    float spring = 21000.0f;
    PhysicsRaycastResult result = sc.physicsWorld.RaycastSingle(
        Ray(wheel.parent.worldRotation *
               position + wheel.parent.worldPosition,
            wheel.parent.worldRotation * Vector3(0.0f, -1.0f, 0.0f)),
        length,
        STATIC_LAYER|VEHICLE_LAYER|CHARACTER_LAYER);
    float distance;
    if (result.body !is null) {
        comp = 1.0f - result.distance / length;
        distance = result.distance;
    } else
        distance = length;
    float springv = (distance - prevdistance) / timeStep;
    float springf = spring * (length - distance);
    float damperf = damping * springv;
    float force = springf - damperf;
    RigidBody@ body = wheel.parent.GetComponent("RigidBody");
    body.ApplyForce(wheel.worldRotation * Vector3(0.0f, 1.0f, 0.0f) * force, position);
    prevdistance = distance;
}</code></pre>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/28ebc440ecd4098f2a6ad505cdc9ec368de1a0cd2616ecbd951089089330fbd9.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      slapin
     </div>
     <div class="post_content">
      <p>
       Also this way never gets good results, it never hovers, just either jumps or lays on collision shape.
       <br/>
       Strangely, similar code works in Unity. Looks like Bullet was not made for it and something have
       <br/>
       to be hacked on low level…
      </p>
     </div>
    </div>
   </div>
   <div class="post_container">
    <div class="avatar_container">
     <img class="avatar" src="../../../images/28ebc440ecd4098f2a6ad505cdc9ec368de1a0cd2616ecbd951089089330fbd9.png"/>
    </div>
    <div class="post">
     <div class="user_name">
      slapin
     </div>
     <div class="post_content">
      <p>
       Well, it looks like the problem is either AngelScript or something…
       <br/>
       C++ version of code works fine and stable. Also
       <span class="mention">
        @Lumak
       </span>
       's Bullet raycast vehicle code works great.
      </p>
      <p>
       <span class="mention">
        @Lumak
       </span>
       do you plan to submit bullet vehicle as standard component to Urho?
       <br/>
       I stress-tested it with 100 cars and don’t see much CPU load.
       <br/>
       I wonder how Unity people live with JavaScript - looks like JavaScript is much faster than
       <br/>
       AngelScript running FixedUpdate… So now I have to rewrite all my tight loops in C++.
       <br/>
       Too bad I’m so not into C++, I hope I can glue C code in there, so to maintain sanity…
       <br/>
       Hope I will get there eventually…
      </p>
     </div>
    </div>
   </div>
  </div>
 </body>
</html>